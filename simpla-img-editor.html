<link rel="import" href="../polymer/polymer.html"> <link rel="import" href="../simpla-styles/simpla-styles.html"> <link rel="import" href="../iron-iconset-svg/iron-iconset-svg.html"> <link rel="import" href="../iron-icon/iron-icon.html" async> <link rel="import" href="../paper-slider/paper-slider.html" async> <iron-iconset-svg name="simpla-img"> <svg> <defs> <g id="camera-alt"><circle cx="12" cy="12" r="3.2"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></g> <g id="title"><path d="M5 4v3h5.5v12h3V7H19V4z"/></g> </defs> </svg> </iron-iconset-svg> <dom-module id="simpla-img-editor"> <template> <style>*,::after,::before,:host{box-sizing:border-box}:host{display:block;position:absolute;outline:0;-webkit-transition:box-shadow 130ms var(--simpla-easing-standard),-webkit-transform .2s var(--simpla-easing-standard);transition:box-shadow 130ms var(--simpla-easing-standard),-webkit-transform .2s var(--simpla-easing-standard);transition:box-shadow 130ms var(--simpla-easing-standard),transform .2s var(--simpla-easing-standard);transition:box-shadow 130ms var(--simpla-easing-standard),transform .2s var(--simpla-easing-standard),-webkit-transform .2s var(--simpla-easing-standard);-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-smoothing:antialiased}:host([hidden])){display:none}:host([visible]){box-shadow:var(--simpla-elevation-1)}.editor{position:relative;width:100%;height:100%;overflow:hidden}.cropper-view-box{outline:0}.cropper-face{opacity:0}.cropper-line,.cropper-point{display:none}.tools,.zoom{position:absolute;background:var(--simpla-bright-white);z-index:1;height:30px;-webkit-transition:-webkit-transform 130ms var(--simpla-easing-decelerate);transition:-webkit-transform 130ms var(--simpla-easing-decelerate);transition:transform 130ms var(--simpla-easing-decelerate);transition:transform 130ms var(--simpla-easing-decelerate),-webkit-transform 130ms var(--simpla-easing-decelerate)}.tools{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;top:0;right:7px;border-bottom-left-radius:var(--simpla-border-radius);border-bottom-right-radius:var(--simpla-border-radius);color:var(--simpla-grey-700)}.zoom{bottom:0;width:85%;left:0;right:0;margin:auto;border-top-left-radius:var(--simpla-border-radius);border-top-right-radius:var(--simpla-border-radius)}:host(:not([visible])) .tools,:host(:not([visible])) .zoom{-webkit-transition-duration:60ms;transition-duration:60ms;-webkit-transition-timing-function:var(--simpla-easing-accelerate);transition-timing-function:var(--simpla-easing-accelerate)}:host(:not([visible])) .zoom{-webkit-transform:translateY(100%);transform:translateY(100%)}:host(:not([visible])) .tools{-webkit-transform:translateY(-100%);transform:translateY(-100%)}.zoom__slider{width:100%;height:100%;cursor:pointer;--paper-slider-active-color:var(--simpla-primary-color);--paper-slider-knob-color:var(--simpla-primary-color);--paper-slider-container-color:var(--simpla-grey-500);--paper-slider-knob-start-border-color:var(--simpla-grey-700)}.tools__tool{display:inline-block;padding:5px 10px 7px;cursor:pointer}.tools__tool:hover,.tools__tool[data-active]{color:var(--simpla-primary-color)}.tools__tool__icon{--iron-icon-width:15px;--iron-icon-height:15px}.title-input{background:0 0;border:none;width:0;padding:0;outline:0;-webkit-transition:width 150ms var(--simpla-easing-standard);transition:width 150ms var(--simpla-easing-standard)}.title-input::-webkit-input-placeholder{color:var(--simpla-grey-700)}.title-input::-moz-placeholder{color:var(--simpla-grey-700)}.title-input:-ms-input-placeholder{color:var(--simpla-grey-700)}.title-input::placeholder{color:var(--simpla-grey-700)}.title-input[data-expanded]{width:80px;padding-left:1em}.editor-img{-webkit-user-drag:none;vertical-align:bottom;-webkit-transform-origin:0 0;transform-origin:0 0;width:inherit;height:inherit;cursor:move}[hidden]{display:none!important}</style> <div class="editor"> <div class="tools" on-transitionend="_hideIfInactive"> <input type="text" id="title-input" class="title-input" placeholder="Enter a title" value="{{alt::input}}" data-expanded$="[[_titleOpen]]" on-blur="_toggleTitle"> <a class="tools__tool" on-tap="_toggleTitle" data-active$="[[_titleOpen]]"> <iron-icon class="tools__tool__icon" icon="simpla-img:title"> </iron-icon> </a> <a class="tools__tool" on-tap="openFilePicker"> <iron-icon class="tools__tool__icon" icon="simpla-img:camera-alt"> </iron-icon> <input type="file" id="file-input" on-change="_uploadImg" hidden> </a> </div> <img id="source" hidden="[[!src]]" class="editor-img" crossorigin="anonymous" src$="[[src]]" width$="[[width]]" height$="[[height]]" on-track="_dragImage" on-tap="_handleImgTap" on-load="_imageLoaded"> <div class="zoom" on-transitionend="_hideIfInactive"> <paper-slider id="slider" class="zoom__slider" immediate-value="{{zoom}}" value="[[zoom]]" step="0.01" min="1" max="3" no-ink=""> </paper-slider> </div> </div> </template> <script>!function(){"use strict";function t(t,e,i){var n=t.width,s=t.height,o=void 0;return o=Math.min(1,Math.min(e.width/n,e.height/s)),(o*n<i.width||o*s<i.height)&&(o=Math.max(i.width/n,i.height/s)),{width:Math.round(n*o),height:Math.round(s*o)}}function e(t,e,i){var n=t.top,s=t.left,o=t.width,r=t.height,a=s+o,h=n+r,l=0,u=0,c=void 0;return c={left:e.scrollX+i,top:e.scrollY+i,right:e.scrollX+e.innerWidth-i,bottom:e.scrollY+e.innerHeight-i},s<c.left?l=c.left-s:a>c.right&&(l=c.right-a),n<c.top?u=c.top-n:h>c.bottom&&(u=c.bottom-h),{translateY:u,translateX:l}}function i(i,n){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r,h=void 0,l=void 0,u=void 0,c=void 0,d=void 0;h={width:n.innerWidth-2*s,height:n.innerHeight-2*s};var f=t(i,h,a);l=f.width,u=f.height;var v=e({top:i.top,left:i.left,width:l,height:u},n,s);return c=v.translateX,d=v.translateY,{width:l,height:u,translateX:c,translateY:d}}function n(t,e){return t<e.min?e.min:t>e.max?e.max:t}function s(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=Math.pow(10,e);return Math.round(t*i)/i}var o=8,r={width:180,height:130},a={observers:["_fitIntoVisibleWindow(top, left, width, height, visible)"],_fitIntoVisibleWindow:function(t,e,n,s,o){var r=this;o||(this.style.transform=""),this.debounce("fit-to-window",function(){var o={top:t,left:e,width:n,height:s},a=void 0,h=void 0,l=void 0,u=i(o,window);n=u.width,s=u.height,a=u.translateX,h=u.translateY,r.width=n,r.height=s,r.style.transform="translate("+a+"px, "+h+"px)",l=!(n===o.width&&s===o.height&&!a&&!h),l&&r.fire("popped-out")})}},h=1,l=0,u=0,c=[1,0,0,1,0,0],d="pan-finished",f="data:,",v=document.createElement("canvas"),p=v.getContext("2d"),g={properties:{output:{type:String,notify:!0},position:{type:Object,value:function(){return{x:0,y:0}},observer:"_positionChanged",notify:!0},debounceDuration:{type:Number,value:100},_transform:{type:String,value:""}},observers:["_updateStyles(_transform)","_debouncedRender(_transform, src)","_updatePosition(_transform)","_updateScale(zoom)"],attached:function(){this.setScrollDirection("all",this.$.source)},_paint:function(){var t=this;this._tick&&(cancelAnimationFrame(this._tick),this._tick=null),this._tick=requestAnimationFrame(function(){var e=t.scale,i=t.translateX,n=t.translateY;t._transform="scale("+e+") translateX("+i+"px) translateY("+n+"px)"})},_updateScale:function(t){this.scale=t},get scale(){return this._scale||h},set scale(t){var e=this.minScale;t<e?this._scale=s(parseFloat(e),2):this._scale=s(parseFloat(t),2),this.translateX+=0,this.translateY+=0,this._paint()},get translateX(){return this._translateX||l},set translateX(t){this._translateX=s(n(t,this._bounds.x)),this._paint()},get translateY(){return this._translateY||u},set translateY(t){this._translateY=s(n(t,this._bounds.y)),this._paint()},get minScale(){var t=this.height/this.$.source.height,e=this.width/this.$.source.width;return isNaN(t)||isNaN(e)?1:t<e?t:e},get _bounds(){return this._imgWidth&&this._width&&this._imgHeight&&this._height?{x:{min:-(this._imgWidth*this.scale-this._width)/this.scale,max:0},y:{min:-(this._imgHeight*this.scale-this._height)/this.scale,max:0}}:{x:{min:Number.NEGATIVE_INFINITY,max:Number.POSITIVE_INFINITY},y:{min:Number.NEGATIVE_INFINITY,max:Number.POSITIVE_INFINITY}}},_resetDimensions:function(){this._width=this.offsetWidth,this._height=this.offsetHeight,this._imgWidth=this.$.source.offsetWidth,this._imgHeight=this.$.source.offsetHeight},_dragImage:function(t){var e=t.detail,i=e.dx,n=e.dy,s=e.ddx,o=e.ddy,r=e.state;"start"===r&&this._resetDimensions(),this.translateX+=("start"===r?i:s)/this.scale,this.translateY+=("start"===r?n:o)/this.scale,"end"===r&&this.fire(d)},_imageLoaded:function(){this._resetDimensions()},_positionChanged:function(t){if(t){var e=t.x,i=t.y;this.translateX=e,this.translateY=i}},_updatePosition:function(){this.position={x:this.translateX,y:this.translateY}},_updateStyles:function(t){this.$.source.style.transform=t},_debouncedRender:function(){this.debounce("render",this._render,this.debounceDuration)},_render:function(){var t=this.width,e=this.height,i=this.scale,n=this.translateX,s=this.translateY,o=this.$.source,r=o.naturalWidth,a=o.naturalHeight,h=t/r,l=e/a,u=void 0;v.width=r,v.height=a,p.setTransform.apply(p,c),p.scale(i,i),p.translate(n/h,s/l),p.drawImage(this.$.source,0,0),u=v.toDataURL(),this.output=u===f?"":u}},b=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},_=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),y=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t},m=function(){function t(){b(this,t)}return _(t,[{key:"beforeRegister",value:function(){this.is="simpla-img-editor",this.properties={active:{type:Boolean,value:!1,notify:!0},visible:{type:Boolean,reflectToAttribute:!0,readonly:!0,value:!1},hidden:{type:Boolean,reflectToAttribute:!0,readonly:!0,value:!0},src:{type:String,notify:!0},alt:{type:String,notify:!0,value:""},zoom:{type:Number,notify:!0,value:1},position:{type:Object,value:function(){return{x:0,y:0}}},width:{type:Number,observer:"_observeWidth"},height:{type:Number,observer:"_observeHeight"},top:{type:Number,observer:"_observeTop",value:0},left:{type:Number,observer:"_observeLeft",value:0},output:{type:String,notify:!0},_titleOpen:{type:Boolean,value:!1},tabindex:{type:Number,reflectToAttribute:!0,value:0}},this.observers=["_toggleVisibility(active)","_focusOnActive(active)"]}},{key:"clear",value:function(){y(this,{src:"",alt:"",zoom:1})}},{key:"openFilePicker",value:function(t){t&&t.stopPropagation(),this.fire("opening-filepicker"),this.$["file-input"].click()}},{key:"_observeWidth",value:function(t){this.style.width=t+"px"}},{key:"_observeHeight",value:function(t){this.style.height=t+"px"}},{key:"_observeLeft",value:function(t){this.style.left=t+"px"}},{key:"_observeTop",value:function(t){this.style.top=t+"px"}},{key:"_toggleVisibility",value:function(t){var e=this;t?(this.hidden=!1,Polymer.RenderStatus.afterNextRender(this,function(){return e.visible=!0})):this.visible=!1}},{key:"_hideIfInactive",value:function(t){this.active||(this.hidden=!0,this.visible=!1)}},{key:"_uploadImg",value:function(t){var e=this,i=t.target.files,n=new FileReader,s=function t(i){e.src=i.target.result,n.removeEventListener("load",t)};this.fire("image-loaded"),this.focus(),i&&i[0]&&(n.addEventListener("load",s),n.readAsDataURL(i[0]))}},{key:"focus",value:function(){var t=window,e=t.scrollY,i=t.scrollX;HTMLElement.prototype.focus.call(this),window.scrollTo(i,e)}},{key:"_toggleTitle",value:function(){this._titleOpen=!this._titleOpen}},{key:"_focusOnActive",value:function(t){var e=this;t&&this.async(function(){return e.focus()},0)}},{key:"behaviors",get:function(){return[a,g]}}]),t}();Polymer(m)}()</script> </dom-module> 