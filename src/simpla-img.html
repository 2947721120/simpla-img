<link rel="import" href="../polymer/polymer.html">

<dom-module id="simpla-img">
  <script>
    import simpla from './behaviors/img/simpla';
    import editorMediator from './behaviors/mediator';

    const CONDITIONAL_STYLES = {
      editable: {
        cursor: 'pointer'
      },
      editing: {
        visibility: 'hidden',
        // Prevent flash while editor opening
        transition: 'visibility',
        transitionDelay: '50ms'
      },
      placeholder: {
        background: '#b2bcc8',
        width: '100px',
        height: '100px'
      }
    };

    class SimplaImg {
      beforeRegister() {
        this.is = 'simpla-img';

        this.extends = 'img';

        this.properties = {

          /**
           * Image src
           * @type {String}
           */
          src: {
            type: String,
            reflectToAttribute: true,
            value: '',
            notify: true
          },

          /**
           * Image alt value
           * @type {String}
           */
          alt: {
            type: String,
            reflectToAttribute: true,
            value: '',
            notify: true
          },

          /**
           * Whether image is editable
           * @type {Boolean}
           */
          editable: {
            type: Boolean,
            notify: true,
            value: false,
          },

          /**
           * Whether image is currently being edited in editor
           * @type {Boolean}
           */
          editing: {
            type: Boolean,
            notify: true,
            value: false
          }

        };

        this.observers = [
          '_styleEditable(editable)',
          '_styleEditing(editing)',
          '_showPlaceholder(editable, editing, src)',
        ];
      }

      get behaviors() {
        return [ simpla, editorMediator ];
      }

      /**
       * Set inline styles for editable state
       * @param  {Boolean} editable Value of the editable prop
       * @return {undefined}
       */
      _styleEditable(editable) {
        this._toggleStyles(CONDITIONAL_STYLES.editable, editable);
      }

      /**
       * Set inline styles for editing state
       * @param  {Boolean} editing Value of the editing prop
       * @return {undefined}
       */
      _styleEditing(editing) {
        this._toggleStyles(CONDITIONAL_STYLES.editing, editing);
      }

      /**
       * Fake a basic placeholder with inline styles
       * @param  {Boolean} editable Value of the editable prop
       * @param  {Boolean} editing Value of the editable prop
       * @param  {String} src       Value of the src prop
       * @return {undefined}
       */
      _showPlaceholder(editable, editing, src) {
        let showPlaceholder = editable && !editing && !src;

        this._toggleStyles(CONDITIONAL_STYLES.placeholder, showPlaceholder);
      }

      /**
       * Helper function to toggle inline styles on the element
       * @param  {Object} styleObject Styles as a JS object
       * @param  {Boolean} state       Whether to apply or remove styles
       * @return {undefined}
       */
      _toggleStyles(styleObject, state) {
        Object.keys(styleObject).forEach(style => {
          this.style[style] = state ? styleObject[style] : '';
        });
      }

      /**
       * Stop editing on viewport resize
       * (Since we're fixed width and abspos)
       * @param  {Boolean} editing Current value of the editing property
       * @return {undefined}
       */
      _stopEditingOnResizeOrScroll(editing) {
        let exit = this.__exitHandler = this.__exitHandler || (() => this.editing = false);

        if (editing) {
          window.addEventListener('resize', exit);
          window.addEventListener('scroll', exit);
        } else {
          window.removeEventListener('resize', exit);
          window.removeEventListener('scroll', exit);
        }
      }

      /**
       * Stop Editing on Hot Keys
       * @param  {Event} e Keydown event on host
       * @return {undefined}
       */
      _stopEditingOnHotkeys(e) {
        let cmdEnter = e.keyCode === 13 && e.metaKey,
            escape = e.keyCode === 27;

        if (cmdEnter || escape) {
          this.editing = false;
        }
      }
    };
    Polymer(SimplaImg);
  </script>
</dom-module>
