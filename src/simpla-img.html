<link rel="import" href="../polymer/polymer.html">

<dom-module id="simpla-img">
  <script>
    import simpla from './behaviors/img/simpla';
    import editor from './behaviors/img/editor';

    const CONDITIONAL_STYLES = {
      editable: {
        cursor: 'pointer'
      },
      editing: {
        visibility: 'hidden',
        // Prevent flash while editor opening
        transition: 'visibility',
        transitionDelay: '50ms'
      },
      placeholder: {
        minHeight: '130px',
        minWidth: '180px',
        backgroundColor: '#b2bcc8'
      }
    };

    /**
     * Polymer SimplaImg element definition
     *
     * Note: We're using the object definition to properly extend an `img` element.
     *  Using ES6 classes, Polymer won't properly setup the inheritance chain and
     *  it won't extend the HTMLImageElement, even if specified using the definition:
     *  `class SimplaImg extends HTMLImageElement { ... }`
     */
    const SimplaImg = {
      is: 'simpla-img',

      extends: 'img',

      properties: {

        /**
         * Image src
         * @type {String}
         */
        src: {
          type: String,
          reflectToAttribute: true,
          value: '',
          notify: true
        },

        /**
         * Image alt value
         * @type {String}
         */
        alt: {
          type: String,
          reflectToAttribute: true,
          value: '',
          notify: true
        },

        /**
         * Whether image is editable
         * @type {Boolean}
         */
        editable: {
          type: Boolean,
          reflectToAttribute: true,
          notify: true,
          value: false,
        },

        /**
         * Whether image is currently being edited in editor
         * @type {Boolean}
         */
        editing: {
          type: Boolean,
          notify: true,
          value: false
        },

      },

      observers: [
        '_styleEditable(editable)',
        '_styleEditing(editing)',
        '_showPlaceholder(editable, editing, src)',
      ],

      listeners: {
        'tap': '_tapHandler'
      },

      behaviors: [ simpla, editor ],

      /**
       * Set inline styles for editable state
       * @param  {Boolean} editable Value of the editable prop
       * @return {undefined}
       */
      _styleEditable(editable) {
        this._toggleStyles(CONDITIONAL_STYLES.editable, editable);
      },

      /**
       * Set inline styles for editing state
       * @param  {Boolean} editing Value of the editing prop
       * @return {undefined}
       */
      _styleEditing(editing) {
        this._toggleStyles(CONDITIONAL_STYLES.editing, editing);
      },

      /**
       * Fake a basic placeholder with inline styles
       * @param  {Boolean} editable Value of the editable prop
       * @param  {Boolean} editing Value of the editable prop
       * @param  {String} src       Value of the src prop
       * @return {undefined}
       */
      _showPlaceholder(editable, editing, src) {
        let showPlaceholder = editable && !editing && !src;

        this._toggleStyles(CONDITIONAL_STYLES.placeholder, showPlaceholder);
      },

      /**
       * Helper function to toggle inline styles on the element
       * @param  {Object}  styles     Styles as key value object - same format as
       *                                HTMLElement.prototype.styles
       * @param  {Boolean} apply      Whether to apply or remove styles
       * @return {undefined}
       */
      _toggleStyles(styles, apply) {
        let cache = this.__styleCache = this.__styleCache || {},
            getEntriesIn = (obj) => Object.keys(obj).map(key => [ key, obj[key] ]);

        getEntriesIn(styles).forEach(([ property, value ]) => {
          let cachedValue = cache[property],
              currentValue = this.style[property];

          if (apply) {
            cache[property] = currentValue;
          } else {
            cache[property] = '';
            value = cachedValue || '';
          }

          this.style[property] = value;
        });
      },

      _tapHandler() {
        if (this.editable) {
          this.editing = true;
        }
      }
    };
    Polymer(SimplaImg);
  </script>
</dom-module>
