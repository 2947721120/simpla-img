<link rel="import" href="../polymer/polymer.html">

<dom-module id="simpla-img">
  <script>
    import simpla from './behaviors/img/simpla';

    const EDITOR_COMPONENT = 'simpla-img-editor.html',
          CONDITIONAL_STYLES = {
            editable: {
              cursor: 'pointer'
            },
            editing: {
              visibility: 'hidden',
              // Prevent flash while editor opening
              transition: 'visibility',
              transitionDelay: '50ms'
            },
            placeholder: {
              background: '#b2bcc8',
              width: '100px',
              height: '100px'
            }
          };

    class SimplaImg {
      beforeRegister() {
        this.is = 'simpla-img';

        this.extends = 'img';

        this.properties = {

          /**
           * Image src
           * @type {String}
           */
          src: {
            type: String,
            reflectToAttribute: true,
            value: '',
            notify: true
          },

          /**
           * Image alt value
           * @type {String}
           */
          alt: {
            type: String,
            reflectToAttribute: true,
            notify: true
          },

          data: {
            type: Object,
            value: () => ({})
          },

          /**
           * Whether image is editable
           * @type {Boolean}
           */
          editable: {
            type: Boolean,
            notify: true,
            value: false,
          },

          /**
           * Whether image is currently being edited in editor
           * @type {Boolean}
           */
          editing: {
            type: Boolean,
            notify: true,
            readonly: true,
            value: false
          },

          /**
           * Unedited image in session
           * For non-destructive edits
           * @type {String}
           */
          _currentImg: {
            type: String,
            value: ''
          }

        };

        this.observers = [
          '_importEditor(editable)',
          '_styleEditable(editable)',
          '_styleEditing(editing)',
          '_showPlaceholder(editable, editing, src)',
          '_setCurrentImg(src, _currentImg)'
        ];

        this.listeners = {
          tap: 'edit'
        }
      }

      get behaviors() {
        return [ simpla ];
      }

      /**
       * Open editor if image is editable
       * @return {undefined}
       */
      edit() {
        let editor,
            { top, left, width, height } = this.getBoundingClientRect();

        if (!this.editable) {
          return;
        }

        editor = Simpla.SimplaImgEditor.singleton;

        Simpla.SimplaImg = Simpla.SimplaImg || {};
        Simpla.SimplaImg.activeInstance = this;

        if (!this.src) {
          editor.bounds = { top, left };
          editor.openFilePicker();
        } else {
          editor.src = this._currentImg;
          editor.set('data.canvas', this.data.editorCanvas || {});
          editor.set('data.zoomFactor', this.data.editorZoomFactor || 1);
          editor.bounds = { top, left, width, height };
          editor.active = true;
        }

        this.editing = true;
        this._stopEditingOnEditorClose();
      }

      /**
       * Imports editor component when editable is true
       * @param  {Boolean} editable Current value of the editable property
       * @return {undefined}
       */
      _importEditor(editable) {
        let editorUrl = this.resolveUrl(EDITOR_COMPONENT),
            editorExists = Simpla && Simpla.SimplaImgEditor && Simpla.SimplaImgEditor.singleton,
            link;

        if (!editable || !!editorExists) {
          return;
        }

        link =  document.createElement('link');
        link.rel = 'import';
        link.href = editorUrl;
        document.head.appendChild(link);
      }

      /**
       * Store unedtied src image for future crops in session
       * @param {String} src        Value of the src property
       * @param {Object} currentImg Value of the currentImg property
       * @return {undefined}
       */
      // TODO: This obviously isn't good enough, need new pattern
      _setCurrentImg(src, currentImg) {
        if (src && !currentImg) {
          this._currentImg = src;
        }
      }

      /**
       * Set _editing prop to false when editor for this image closed
       * @return {undefined}
       */
      _stopEditingOnEditorClose() {
        let editor = Simpla.SimplaImgEditor.singleton,
            imgGlobal = Simpla.SimplaImg,
            stopEditingIfInactive = (e) => {
              if (!e.detail.value && imgGlobal.activeInstance === this) {
                imgGlobal.activeInstance = null;
                this.editing = false;
              }
              editor.removeEventListener('active-changed', stopEditingIfInactive);
            };

        editor.addEventListener('active-changed', stopEditingIfInactive);
      }

      /**
       * Set inline styles for editable state
       * @param  {Boolean} editable Value of the editable prop
       * @return {undefined}
       */
      _styleEditable(editable) {
        this._toggleStyles(CONDITIONAL_STYLES.editable, editable);
      }

      /**
       * Set inline styles for editing state
       * @param  {Boolean} editing Value of the editing prop
       * @return {undefined}
       */
      _styleEditing(editing) {
        this._toggleStyles(CONDITIONAL_STYLES.editing, editing);
      }

      /**
       * Fake a basic placeholder with inline styles
       * @param  {Boolean} editable Value of the editable prop
       * @param  {Boolean} editing Value of the editable prop
       * @param  {String} src       Value of the src prop
       * @return {undefined}
       */
      _showPlaceholder(editable, editing, src) {
        let showPlaceholder = editable && !editing && !src;

        this._toggleStyles(CONDITIONAL_STYLES.placeholder, showPlaceholder);
      }

      /**
       * Helper function to toggle inline styles on the element
       * @param  {Object} styleObject Styles as a JS object
       * @param  {Boolean} state       Whether to apply or remove styles
       * @return {undefined}
       */
      _toggleStyles(styleObject, state) {
        Object.keys(styleObject).forEach(style => {
          this.style[style] = state ? styleObject[style] : '';
        });
      }

    };
    Polymer(SimplaImg);
  </script>
</dom-module>
