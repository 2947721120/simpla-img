<link rel="import" href="../polymer/polymer.html"> <dom-module id="simpla-img"> <script>!function(){"use strict";var e=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},a={properties:{uid:{type:String,observer:"_initUid"},_simplaObservers:{type:Object,value:function(){return{}}}},observers:["_setData(data.*, uid)"],created:function(){window.Simpla||console.error("Cannot find Simpla global")},attached:function(){this._observeEditable()},detached:function(){var e=this;Object.keys(this._simplaObservers).forEach(function(t){e._simplaObservers[t].unobserve()}),this._simplaObservers=[]},_initUid:function(e){var t=this;Simpla.get(e).then(function(e){e&&e.data&&i(t.data,e.data)}),this._observeBuffer(e)},_setData:function(e,t){var i=e.value,a=i.src,n=i.alt;return Simpla.set(t,{type:"Image",data:{src:a,alt:n}})},_observeBuffer:function(e){var t=this,a=this._simplaObservers,n=function(e){e&&e.data&&i(t,e.data)};e&&(a.buffer&&a.buffer.unobserve(),a.buffer=Simpla.observe(e,n))},_observeEditable:function(){var e=this,t=this._simplaObservers;this.editable=Simpla.getState("editable"),t.editable&&t.editable.unobserve(),t.editable=Simpla.observeState("editable",function(t){return e.editable=t})}},n="simpla-img-editor.html",r={editable:{cursor:"pointer"},editing:{visibility:"hidden",transition:"visibility",transitionDelay:"50ms"},placeholder:{background:"#b2bcc8",width:"100px",height:"100px"}},o=function(){function i(){e(this,i)}return t(i,[{key:"beforeRegister",value:function(){this.is="simpla-img",this.extends="img",this.properties={src:{type:String,reflectToAttribute:!0,value:"",notify:!0},alt:{type:String,reflectToAttribute:!0,notify:!0},data:{type:Object,value:function(){return{}}},editable:{type:Boolean,notify:!0,value:!1},editing:{type:Boolean,notify:!0,readonly:!0,value:!1},_currentImg:{type:String,value:""}},this.observers=["_importEditor(editable)","_styleEditable(editable)","_styleEditing(editing)","_showPlaceholder(editable, editing, src)","_setCurrentImg(src, _currentImg)"],this.listeners={tap:"edit"}}},{key:"edit",value:function(){var e=void 0,t=this.getBoundingClientRect(),i=t.top,a=t.left,n=t.width,r=t.height;this.editable&&(e=Simpla.SimplaImgEditor.singleton,Simpla.SimplaImg=Simpla.SimplaImg||{},Simpla.SimplaImg.activeInstance=this,this.src?(e.src=this._currentImg,e.set("data.canvas",this.data.editorCanvas||{}),e.set("data.zoomFactor",this.data.editorZoomFactor||1),e.bounds={top:i,left:a,width:n,height:r},e.active=!0):(e.bounds={top:i,left:a},e.openFilePicker()),this.editing=!0,this._stopEditingOnEditorClose())}},{key:"_importEditor",value:function(e){var t=this.resolveUrl(n),i=Simpla&&Simpla.SimplaImgEditor&&Simpla.SimplaImgEditor.singleton,a=void 0;e&&!i&&(a=document.createElement("link"),a.rel="import",a.href=t,document.head.appendChild(a))}},{key:"_setCurrentImg",value:function(e,t){e&&!t&&(this._currentImg=e)}},{key:"_stopEditingOnEditorClose",value:function(){var e=this,t=Simpla.SimplaImgEditor.singleton,i=Simpla.SimplaImg,a=function a(n){n.detail.value||i.activeInstance!==e||(i.activeInstance=null,e.editing=!1),t.removeEventListener("active-changed",a)};t.addEventListener("active-changed",a)}},{key:"_styleEditable",value:function(e){this._toggleStyles(r.editable,e)}},{key:"_styleEditing",value:function(e){this._toggleStyles(r.editing,e)}},{key:"_showPlaceholder",value:function(e,t,i){var a=e&&!t&&!i;this._toggleStyles(r.placeholder,a)}},{key:"_toggleStyles",value:function(e,t){var i=this;Object.keys(e).forEach(function(a){i.style[a]=t?e[a]:""})}},{key:"behaviors",get:function(){return[a]}}]),i}();Polymer(o)}()</script> </dom-module> 