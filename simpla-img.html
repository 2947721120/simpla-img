<link rel="import" href="../polymer/polymer.html"> <link rel="import" href="../sm-ui-core/sm-ui-core.html"> <link rel="import" href="../sm-utility-placeholder/sm-utility-placeholder.html"> <link rel="import" href="../sm-utility-share/sm-utility-share.html"> <link rel="import" href="../sm-utility-connect/sm-utility-connect.html"> <link rel="import" href="../default-content/default-content.html"> <link rel="import" href="../simpla-block/simpla-block.html"> <link rel="import" href="./sm-img-canvas.html"> <link rel="import" href="./sm-img-controls.html"> <dom-module id="simpla-img"> <template> <style include="sm-css"></style><style>:root{--placeholder-background:var(--gray);--placeholder-settings:{background-size:cover;background-position:center center;background-repeat:no-repeat};}:host{@apply(--typography);position:relative;display:inline-block;height:auto;width:auto;overflow:hidden}:host([saving]){pointer-events:none}.editor{width:inherit;height:inherit;overflow:hidden}:host([popped]) .editor{box-shadow:0 2px 2px var(--light-black);z-index:var(--on-top)}.placeholder{width:300px;height:300px;min-width:100%;min-height:100%;max-width:100%;max-height:100%;cursor:pointer;background:var(--placeholder-background);@apply(--placeholder-settings)}.placeholder::before{content:'Upload an image';position:absolute;top:0;right:0;bottom:0;left:0;margin:auto;width:150px;height:50px;text-align:center;font-size:21px;line-height:1.3;font-weight:900;color:var(--med-white);cursor:pointer;z-index:1}</style><sm-utility-placeholder id="placeholder" class="placeholder" show="[[usePlaceholder]]" on-tap="chooseFile"></sm-utility-placeholder> <div class="editor" id="editor"> <sm-img-canvas id="image" src="[[src]]" width="[[width]]" height="[[height]]" scale="[[scale]]" editable="[[editable]]" active="[[active]]" on-pan-finished="updatePosition"> </sm-img-canvas> <sm-img-controls id="controls" zoom="{{scale}}" title="{{title}}" active="[[active]]" on-file-changed="_fileChanged"> </sm-img-controls> </div> <sm-utility-connect id="api" key="[[uid]]" saving="{{saving}}" loading="{{loading}}"> </sm-utility-connect> <sm-utility-share type="state" key="editable" value="{{editable}}"> </sm-utility-share> </template> <script>!function(){"use strict";function e(e){switch(e){case"":case"inherit":case"transparent":return!1;default:return i(e)}}var t={};t.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var i=function(e){var t="rgb(0, 0, 0)",i="rgb(255, 255, 255)",n=document.createElement("img"),o=function(t){return n.style.color=t,n.style.color=e,n.style.color!==t};return o(t)&&o(i)},n="--placeholder-background",o=void 0,a=void 0;o=simpla.behaviors.placeholder({observer:"_placeholderChanged",value:"rgb(200,200,200)"},{observer:"_usePlaceholderChanged"}),a={observers:["_setPlaceholderFromEditable(editable)","_setPlaceholderFromSrc(src)"],_setPlaceholderFromEditable:function(e){this.usePlaceholder=e&&(!this.src||""===this.src)},_setPlaceholderFromSrc:function(e){this.usePlaceholder=this.editable&&(!e||""===e)},_usePlaceholderChanged:function(e){this._canvas.style.display=e?"none":""},_placeholderChanged:function(t){this.customStyle[n]=e(t)?t:"url("+t+")",this.updateStyles()}};var s=[o,a],r=void 0,l=void 0;r=simpla.behaviors["default"](),l={properties:{useDefault:{type:Boolean,observer:"_useDefaultChanged",value:!1}},observers:["_updateDefault(useDefault, _default)"],_updateDefault:function(e,t){e&&(this.src=this._default)},_useDefaultChanged:function(e){e&&this._default&&(this.src=this._default)},_setDefaultAttribute:function(e){this._default=e},_setDefaultElement:function(e){var t=Polymer.dom(e).querySelector("img");this._default=t.src}};var c=[r,l],h=void 0,u=void 0;h=simpla.behaviors.persists("api"),u={listeners:{"api.loaded":"_updateFromLoad"},observers:["_uidChanged(uid)","_savingChanged(saving)"],get _uploadingAnimation(){var e=.3,t=.7,i=1.5,n=875,o=void 0,a=void 0,s=void 0;return o=parseFloat(window.getComputedStyle(this).opacity),a=o>e?o*t:o*i,s=this.animate([{opacity:o},{opacity:a}],{easing:"ease-in-out",duration:n,direction:"alternate",iterations:2}),s.finish(),s},_toObject:function(){var e=this.src,t=this.position,i=this.title,n=this.scale,o=t.x,a=t.y;return{src:e,position:{x:o,y:a},title:i,scale:n}},_fromObject:function(e){if(e&&0!==Object.keys(e).length){var t=this._canvas.editable;this._canvas.editable=!0,this.src=e.src,this.position=e.position?{x:e.position.x,y:e.position.y}:{x:0,y:0},this.title=e.title,this.scale=e.scale||1,this._canvas.editable=t}else this.useDefault=!0},_equal:function(e,t){return!(!e||!t)&&e.src===t.src&&e.position&&t.position&&e.position.x===t.position.x&&e.position.y===t.position.y&&e.title===t.title&&e.scale===t.scale},_updateFromLoad:function(e){var t=e.detail;this._fromObject(t.value)},_uidChanged:function(){this.load()},_savingChanged:function(e){var t=this,i=this._uploadingAnimation;e&&(this.active=!1,i.play(),i.onfinish=function(){t.saving&&i.play()})}};var d=[h,u],p={easing:simpla._constants.easings.easeOutCubic,fill:"both",duration:150},f=1.02,v=12,g=15,y={properties:{popout:{type:Boolean,reflectToAttribute:!0,value:!1},popped:{type:Boolean,value:!1,reflectToAttribute:!0},_prePopped:{type:Object,value:{inlineWidth:"",inlineHeight:""}}},observers:["_togglePopped(active, popout, popped)"],ready:function(){var e=this;window.addEventListener("scroll",function(){e.popped&&(e.active=e.popped=!1)})},_togglePopped:function(e,t,i){!e||!t&&this._inViewport()?i&&this._popBack():this._popOut()},get _poppedFrames(){var e=this.getBoundingClientRect(),t={top:e.top,left:e.left};return e.right>window.innerWidth?t.left=window.innerWidth-e.width-v:e.left<v&&(t.left=v),e.bottom>window.innerHeight?t.top=window.innerHeight-e.height-v:e.top<v&&(t.top=v),[{top:e.top+"px",left:e.left+"px",transform:"scale(1)"},{top:t.top+"px",left:t.left+"px",transform:"scale("+f+")"}]},_popOut:function(){var e=this._poppedFrames,t=this.getBoundingClientRect(),i=this.$.editor;this.popped=!0,this._prePopped.inlineWidth=this.style.width,this._prePopped.inlineHeight=this.style.height,this.style.width=t.width+"px",this.style.height=t.height+"px",i.style.position="fixed",i.animate(e,p)},_popBack:function(){var e=this,t=this._prePopped,i=t.inlineWidth,n=t.inlineHeight,o=this._poppedFrames,a=this.$.editor,s=void 0;s=a.animate(o.reverse(),p),s.onfinish=function(){e.style.width=i,e.style.height=n,a.style.position="",e.popped=!1}},_inViewport:function(){var e=this.getBoundingClientRect(),t=e.top>=-g,i=e.left>=-g,n=e.bottom<=window.innerHeight+g,o=e.right<=window.innerWidth+g;return t&&i&&n&&o}},_=function(){function e(){t.classCallCheck(this,e)}return t.createClass(e,[{key:"beforeRegister",value:function(){this.is="simpla-img",this.properties={src:{type:String,value:""},width:Number,height:Number,scale:{type:Number,value:1},position:{type:Object,value:{x:0,y:0},observer:"_positionChanged"},active:{type:Boolean,notify:!0,value:!1,observer:"_activeChanged"},editable:{type:Boolean,notify:!0}}}},{key:"_positionChanged",value:function(e){this._canvas.translateX=e.x,this._canvas.translateY=e.y}},{key:"ready",value:function(){var e=this;this._syncImgSizing(),window.addEventListener("resize",function(){e.debounce("syncImgSizing",e._syncImgSizing.bind(e))}),"undefined"==typeof this.editable&&(this.editable=!1)}},{key:"updatePosition",value:function(){var e=this._canvas;this.position={x:e.translateX,y:e.translateY}}},{key:"chooseFile",value:function(e){e&&e.stopPropagation(),this._controls.openFilePicker()}},{key:"_fileChanged",value:function(e){var t=this,i=new FileReader,n=e.detail.value;i.onloadend=function(){t.src=i.result,t.active=!0},i.readAsDataURL(n)}},{key:"_activeChanged",value:function(e){var t=this,i=function(e){e.__polymerGesturesHandled||(t.active=!1)};this.active?window.removeEventListener("click",i,!1):window.addEventListener("click",i,!1)}},{key:"_handleTap",value:function(e){var t=e.target;this.editable&&"file"!==t.type&&(t===this._placeholder?this._controls.openFilePicker():this.active=!0)}},{key:"_syncImgSizing",value:function(){var e=this,t=this.$.image,i=function(t){var i=e.style.display,n=void 0,o=void 0;return e.style.display="none",n=window.getComputedStyle(e),o=n[t],e.style.display=i,o.match(/%/)};t.style.width=i("width")?"100%":"inherit",t.style.height=i("height")?"100%":"inherit"}},{key:"behaviors",get:function(){return[].concat(simpla.behaviors.blockNamespaceChild,y,s,c,d)}},{key:"listeners",get:function(){return{tap:"_handleTap"}}},{key:"_canvas",get:function(){return this.$.image}},{key:"_controls",get:function(){return this.$.controls}},{key:"_placeholder",get:function(){return this.$.placeholder}}]),e}();Polymer(_)}();</script></dom-module>